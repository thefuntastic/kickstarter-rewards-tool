<!DOCTYPE html>
<html>
  <head>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <style>
      body, html { font-family: sans-serif;}
      text {  font: 10px Verdana;  }

    </style>

    
  </head>  

  <body>
    <h3>KICKSTARTER BROWSER!</h3>

    <p>Project: 
    <select id="picker"></select>
    </p>

    <script type="text/javascript">

      var dataTest = [10, 5 , 6 , 11];

      var dimensions = 1000;

      var svg = d3.select('body').append('svg')
        .attr("width", dimensions*2)
        .attr("height", dimensions)
        .style("border", "1px solid black");
      // var bubble = d3.layout.pack()
      //   .sort(null)
      //   .size([dimensions, dimensions])
      //   .padding(1.5);
      var nodes = null;

      d3.json("data.json", function(err, root){

      	var dropdown = d3.select('select')
      		.on("change", function(){onChange();});

      	var options = dropdown.selectAll('option')
      		.data( root.items)
      		.enter()
      		.append('option')
      		.text( function (d) { return d.name + " " + d.goal + " " + d.currency; })
      		
      	var onChange = function() {
      		var selectedIndex = dropdown.property('selectedIndex');
      		var rewards = options[0][selectedIndex].__data__.rewards;

      		var currency = options[0][selectedIndex].__data__.currency;


      		nodes = svg.selectAll(".node")
	      		.data(rewards)
	      	
	      	var newNodes = nodes
	      		.enter()
	      		.append('g')
	      		.attr("class", "node")
	      		
	      	newNodes.append("circle");
	      	newNodes.append("title");
	      	newNodes.append("text")
      			.attr("dy", ".3em")
      			.style("text-anchor", "middle")
      

	      	nodes
	      		.exit()
	      		.remove();

	      	var max = d3.max(rewards, function(d) { return d.tier * d.backers});
	      	var min = d3.min(rewards, function(d) { return d.tier * d.backers});

	      	var linScale = d3.scale.linear()
	      		.domain([min, max])
	      		.range([0,100])

	      	nodes
	      		.attr("transform", function(d,i) {
	      			var dx = i* 50 + 100;
	      			var dy = 200;
	      			return "translate(" + dx + "," + dy + ")" ;
	      		});

	      	nodes.select("circle")
		      	.attr("r", function(d){
		      		
		      		if(d.backers <= 0)
		      		{
		      			return 10;
		      		}
		      		return linScale( d.backers * d.tier); ;
		      	})
		      	.style("fill", function(d,i){
		      		if(d.backers<=0) return d3.rgb("#aaa");
		      		return i * 8
		      	})
		      	.style("opacity", 0.5);
	     
	      	nodes.select("title")
	      		.text(function (d) { return d.backers + " backers @ " + d.tier + " = " + d.backers * d.tier})

	      	nodes.select("text")
	      		.text(function(d) { return d.tier ; });

		    console.log(nodes);
      	}
      	
      	onChange();
      	

      		// console.log(nodes);


      });

      

      // var nodes = svg.selectAll("circle")
      // 	.data(dataTest)
      // 	.enter()
      // 	.append('circle');

      // var circleAttr = nodes
      // 	.attr("cx", function(d,i) {return i* 100 + 100;})
      // 	.attr("cy", 200)
      // 	.attr("r", function(d){ return d * 10;})
      // 	.style("fill","blue");


    </script>
  </body>
</html>

